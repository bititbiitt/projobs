{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ILT/projobs/src/app/api/post-job/upload-doc/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\r\nimport crypto from 'crypto';\r\n\r\nexport async function POST(request: Request) {\r\n  try {\r\n    const body = await request.json();\r\n    const { name, mime, data, blobUri, jobId, tenantId, uploadedBy } = body as { name?: string; mime?: string; data?: string; blobUri?: string; jobId?: string; tenantId?: string; uploadedBy?: string };\r\n\r\n    const buffer = data ? Buffer.from(data, 'base64') : Buffer.alloc(0);\r\n    const fileHash = data ? crypto.createHash('sha256').update(buffer).digest('hex') : null;\r\n    const fileSize = buffer.length || null;\r\n\r\n    try {\r\n      const mod = await import('@prisma/client');\r\n      const prisma = new mod.PrismaClient();\r\n\r\n      // create job_document minimal record\r\n      const doc = await prisma.job_document.create({\r\n        data: {\r\n          tenant_id: tenantId ?? null,\r\n          job_id: jobId ?? null,\r\n          file_name: name ?? null,\r\n          current_blob_uri: blobUri ?? null,\r\n          current_version_num: 1,\r\n          uploaded_by: uploadedBy ?? null,\r\n        }\r\n      });\r\n\r\n      // create version linked to the document\r\n      const version = await prisma.job_document_version.create({\r\n        data: {\r\n          doc_id: doc.id,\r\n          version_num: 1,\r\n          blob_uri: blobUri ?? null,\r\n          file_hash: fileHash ?? null,\r\n          file_type: mime ?? null,\r\n          file_size: fileSize ?? null,\r\n          ocr_used: mime === 'application/pdf',\r\n        }\r\n      });\r\n\r\n      // update document to reflect current version\r\n      await prisma.job_document.update({ where: { id: doc.id }, data: { current_version_num: version.version_num, current_blob_uri: version.blob_uri } });\r\n\r\n      try { await prisma.$disconnect(); } catch (e) {}\r\n\r\n      return NextResponse.json({ ok: true, jobDocumentId: doc.id, versionId: version.id });\r\n    } catch (e) {\r\n      return NextResponse.json({ ok: false, error: String(e) }, { status: 500 });\r\n    }\r\n  } catch (err) {\r\n    return NextResponse.json({ ok: false, error: String(err) }, { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEO,eAAe,KAAK,OAAgB;IACzC,IAAI;QACF,MAAM,OAAO,MAAM,QAAQ,IAAI;QAC/B,MAAM,EAAE,IAAI,EAAE,IAAI,EAAE,IAAI,EAAE,OAAO,EAAE,KAAK,EAAE,QAAQ,EAAE,UAAU,EAAE,GAAG;QAEnE,MAAM,SAAS,OAAO,OAAO,IAAI,CAAC,MAAM,YAAY,OAAO,KAAK,CAAC;QACjE,MAAM,WAAW,OAAO,gHAAM,CAAC,UAAU,CAAC,UAAU,MAAM,CAAC,QAAQ,MAAM,CAAC,SAAS;QACnF,MAAM,WAAW,OAAO,MAAM,IAAI;QAElC,IAAI;YACF,MAAM,MAAM;YACZ,MAAM,SAAS,IAAI,IAAI,YAAY;YAEnC,qCAAqC;YACrC,MAAM,MAAM,MAAM,OAAO,YAAY,CAAC,MAAM,CAAC;gBAC3C,MAAM;oBACJ,WAAW,YAAY;oBACvB,QAAQ,SAAS;oBACjB,WAAW,QAAQ;oBACnB,kBAAkB,WAAW;oBAC7B,qBAAqB;oBACrB,aAAa,cAAc;gBAC7B;YACF;YAEA,wCAAwC;YACxC,MAAM,UAAU,MAAM,OAAO,oBAAoB,CAAC,MAAM,CAAC;gBACvD,MAAM;oBACJ,QAAQ,IAAI,EAAE;oBACd,aAAa;oBACb,UAAU,WAAW;oBACrB,WAAW,YAAY;oBACvB,WAAW,QAAQ;oBACnB,WAAW,YAAY;oBACvB,UAAU,SAAS;gBACrB;YACF;YAEA,6CAA6C;YAC7C,MAAM,OAAO,YAAY,CAAC,MAAM,CAAC;gBAAE,OAAO;oBAAE,IAAI,IAAI,EAAE;gBAAC;gBAAG,MAAM;oBAAE,qBAAqB,QAAQ,WAAW;oBAAE,kBAAkB,QAAQ,QAAQ;gBAAC;YAAE;YAEjJ,IAAI;gBAAE,MAAM,OAAO,WAAW;YAAI,EAAE,OAAO,GAAG,CAAC;YAE/C,OAAO,2JAAY,CAAC,IAAI,CAAC;gBAAE,IAAI;gBAAM,eAAe,IAAI,EAAE;gBAAE,WAAW,QAAQ,EAAE;YAAC;QACpF,EAAE,OAAO,GAAG;YACV,OAAO,2JAAY,CAAC,IAAI,CAAC;gBAAE,IAAI;gBAAO,OAAO,OAAO;YAAG,GAAG;gBAAE,QAAQ;YAAI;QAC1E;IACF,EAAE,OAAO,KAAK;QACZ,OAAO,2JAAY,CAAC,IAAI,CAAC;YAAE,IAAI;YAAO,OAAO,OAAO;QAAK,GAAG;YAAE,QAAQ;QAAI;IAC5E;AACF"}}]
}