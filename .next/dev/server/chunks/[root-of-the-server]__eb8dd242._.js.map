{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 124, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ILT/projobs/src/app/api/post-job/parse-doc/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\r\nimport mammoth from 'mammoth';\r\nimport pdfParse from 'pdf-parse';\r\nimport crypto from 'crypto';\r\nimport fs from 'fs';\r\nimport os from 'os';\r\nimport path from 'path';\r\nimport { promisify } from 'util';\r\nimport child_process from 'child_process';\r\nconst exec = promisify(child_process.exec);\r\n\r\n// simple id generator for parse items\r\nconst genId = () => `${Date.now().toString(36)}-${Math.random().toString(36).slice(2,9)}`;\r\n\r\nexport async function POST(request: Request) {\r\n  try {\r\n    const body = await request.json();\r\n    const { name, mime, data, versionId } = body as { name: string; mime: string; data: string; versionId?: string };\r\n    const b = Buffer.from(data, 'base64');\r\n    const lower = String(name || '').toLowerCase();\r\n\r\n    let text = '';\r\n    let html = '';\r\n\r\n    if (lower.endsWith('.docx') || mime === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document') {\r\n      const result = await mammoth.convertToHtml({ buffer: b });\r\n      html = result.value;\r\n      text = stripHtml(result.value);\r\n    } else if (lower.endsWith('.pdf') || mime === 'application/pdf') {\r\n      const pdf = await pdfParse(b as any);\r\n      text = pdf.text || '';\r\n    } else {\r\n      // fallback: try to decode as utf8 text\r\n      text = b.toString('utf8');\r\n    }\r\n\r\n    // For PDFs, run OCR automatically (preferred over raw extracted text when available)\r\n    let finalText = text || html || '';\r\n    if (mime === 'application/pdf' || lower.endsWith('.pdf')) {\r\n      try {\r\n        const ocrText = await tryOcrPdf(b);\r\n        if (ocrText && ocrText.trim().length > 0) {\r\n          finalText = ocrText;\r\n        }\r\n      } catch (e) {\r\n        // ignore OCR failure and continue with existing extracted text\r\n      }\r\n    }\r\n\r\n    // run rule-based parser on extracted text/html\r\n    const parsed = parseTextToQuestions(finalText || html || '');\r\n\r\n    // compute overall confidence (average of item confidences)\r\n    const confidence = parsed.length === 0 ? 0 : Math.max(0, Math.min(1, parsed.reduce((s, p) => s + (p.__confidence||0.7), 0) / parsed.length));\r\n\r\n    // attempt to persist parse result in DB if Prisma is available\r\n    let savedId: string | null = null;\r\n    try {\r\n      const mod = await import('@prisma/client');\r\n      const prisma = new mod.PrismaClient();\r\n\r\n      // if no versionId provided, create a job_document_version record (minimal) so results can be linked\r\n      let targetVersionId = versionId ?? null;\r\n      if (!targetVersionId) {\r\n        try {\r\n          const fileHash = crypto.createHash('sha256').update(b).digest('hex');\r\n          const created = await prisma.job_document_version.create({\r\n            data: {\r\n              doc_id: null,\r\n              version_num: 1,\r\n              blob_uri: null,\r\n              file_hash: fileHash,\r\n              file_type: mime ?? null,\r\n              file_size: b.length,\r\n              ocr_used: mime === 'application/pdf',\r\n            }\r\n          });\r\n          targetVersionId = created.id;\r\n        } catch (inner) {\r\n          // ignore version creation failure, continue to try to save parse result without version link\r\n        }\r\n      }\r\n\r\n      const rec = await prisma.job_document_parse_result.create({\r\n        data: {\r\n          version_id: targetVersionId ?? null,\r\n          parsed_data: parsed,\r\n          confidence: confidence || undefined,\r\n          parse_status: parsed.length > 0 ? 'ok' : 'partial',\r\n          model_version: 'rule-v1'\r\n        }\r\n      });\r\n      savedId = rec.id;\r\n      try { await prisma.$disconnect(); } catch(e){}\r\n    } catch (e) {\r\n      // Prisma not available or DB error — ignore but keep working\r\n    }\r\n\r\n    return NextResponse.json({ ok: true, parsed, confidence, parseResultId: savedId, text, html });\r\n  } catch (err) {\r\n    return NextResponse.json({ ok: false, error: String(err) }, { status: 500 });\r\n  }\r\n}\r\n\r\nfunction stripHtml(html: string) {\r\n  return html.replace(/<[^>]+>/g, ' ').replace(/\\s+/g, ' ').trim();\r\n}\r\n\r\n// RULE-BASED PARSER\r\nfunction parseTextToQuestions(raw: string) {\r\n  const out: any[] = [];\r\n  const blocks = raw.split(/\\n\\s*\\n+/).map(b => b.trim()).filter(Boolean).slice(0, 300);\r\n\r\n  for (const blk of blocks) {\r\n    const lines = blk.split(/\\r?\\n/).map(l => l.trim()).filter(Boolean);\r\n    if (lines.length === 0) continue;\r\n\r\n    // header / question candidate is first line\r\n    const first = lines[0];\r\n    // detect options in following lines\r\n    const optionLines = lines.slice(1).filter(l => /^([\\-\\u2022\\*\\dA-Za-z])[\\).\\-\\s]/.test(l) || /^\\s*[-•*]/.test(l));\r\n    const options = optionLines.length > 0 ? optionLines.map(l => l.replace(/^([\\-\\u2022\\*]|\\d+[\\).]|[A-Za-z][\\).])\\s*/,'').trim ? l.replace(/^([\\-\\u2022\\*]|\\d+[\\).]|[A-Za-z][\\).])\\s*/,'').trim() : l) : [];\r\n\r\n    // infer type\r\n    let type: string = 'text';\r\n    let confidence = 0.7;\r\n\r\n    const lower = blk.toLowerCase();\r\n    if (options.length >= 1) {\r\n      // if options present and look like checkboxes (multiple markers) -> checkbox else radio\r\n      const multiHints = optionLines.some(l => /checkbox|multiple/i.test(l) || /choose all/i.test(blk));\r\n      type = multiHints ? 'checkbox' : 'radio';\r\n      confidence = 0.85;\r\n    } else if (/\\bemail\\b|@/.test(lower)) {\r\n      type = 'email'; confidence = 0.95;\r\n    } else if (/\\bphone\\b|tel\\b|\\(\\d{3}\\)\\s*\\d{3}-\\d{4}|\\b\\d{3}[\\s.-]?\\d{3}[\\s.-]?\\d{4}\\b/.test(lower)) {\r\n      type = 'phone'; confidence = 0.9;\r\n    } else if (/\\b(date|dob|birth)\\b|\\b\\d{1,2}[\\/\\-]\\d{1,2}[\\/\\-]\\d{2,4}\\b/.test(lower)) {\r\n      type = 'date'; confidence = 0.9;\r\n    } else if (first.length > 120 || blk.split(/[\\.\\?\\!]/).length > 3) {\r\n      type = 'textarea'; confidence = 0.75;\r\n    } else if (/\\?$/.test(first) || /^do you |^have you |^are you |^please provide /i.test(first)) {\r\n      type = 'text'; confidence = 0.8;\r\n    }\r\n\r\n    // detect required\r\n    const required = /\\*|required|must provide|mandatory/i.test(blk);\r\n\r\n    // generate label (strip numbering)\r\n    const label = first.replace(/^\\s*(?:\\d+[:.)\\-]?|[A-Za-z][\\).\\-]?|[\\-\\u2022\\*])\\s*/, '').trim();\r\n\r\n    const q: any = { id: genId(), label: label || first, type, options: options.length ? options : undefined, required, category: 'job', __confidence: confidence };\r\n    out.push(q);\r\n  }\r\n\r\n  return out;\r\n}\r\n\r\nfunction looksLikeGarbled(s: string) {\r\n  if (!s) return true;\r\n  const cleaned = s.replace(/\\s+/g, '');\r\n  if (cleaned.length < 120) return true; // too short\r\n  // compute fraction of non-alphanumeric (excluding common punctuation)\r\n  const nonAlpha = (s.match(/[^\\w\\s\\p{P}]/gu) || []).length;\r\n  const ratio = nonAlpha / Math.max(1, s.length);\r\n  return ratio > 0.15; // heuristic\r\n}\r\n\r\nasync function tryOcrPdf(buffer: Buffer) {\r\n  // writes buffer to temp file, tries pdftoppm -> tesseract pipeline or ImageMagick -> tesseract\r\n  const tmpDir = fs.mkdtempSync(path.join(os.tmpdir(), 'ocr-'));\r\n  const pdfPath = path.join(tmpDir, 'doc.pdf');\r\n  fs.writeFileSync(pdfPath, buffer);\r\n  const outPrefix = path.join(tmpDir, 'page');\r\n  try {\r\n    // try pdftoppm\r\n    try {\r\n      await exec(`pdftoppm -png ${escapePath(pdfPath)} ${escapePath(outPrefix)}`);\r\n    } catch (e) {\r\n      // fallback to imagemagick 'magick' or 'convert'\r\n      try {\r\n        await exec(`magick -density 300 ${escapePath(pdfPath)} ${escapePath(outPrefix)}.png`);\r\n      } catch (e2) {\r\n        try {\r\n          await exec(`convert -density 300 ${escapePath(pdfPath)} ${escapePath(outPrefix)}.png`);\r\n        } catch (e3) {\r\n          throw new Error('No PDF->PNG tool available');\r\n        }\r\n      }\r\n    }\r\n\r\n    // collect generated png files\r\n    const files = fs.readdirSync(tmpDir).filter(f => f.endsWith('.png')).map(f => path.join(tmpDir, f)).sort();\r\n    if (files.length === 0) throw new Error('No images produced for OCR');\r\n\r\n    let fullText = '';\r\n    for (const img of files) {\r\n      try {\r\n        // run tesseract to stdout\r\n        const { stdout } = await exec(`tesseract ${escapePath(img)} stdout -l eng`);\r\n        fullText += '\\n\\n' + stdout;\r\n      } catch (e) {\r\n        // tesseract failed for this image, continue\r\n      }\r\n    }\r\n\r\n    // cleanup\r\n    try { fs.rmSync(tmpDir, { recursive: true, force: true }); } catch (e) {}\r\n    return fullText.trim();\r\n  } catch (err) {\r\n    try { fs.rmSync(tmpDir, { recursive: true, force: true }); } catch (e) {}\r\n    throw err;\r\n  }\r\n}\r\n\r\nfunction escapePath(p: string) {\r\n  // simple quoting for paths with spaces\r\n  if (p.indexOf(' ') >= 0) return `\"${p}\"`;\r\n  return p;\r\n}\r\n"],"names":[],"mappings":"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"}}]
}